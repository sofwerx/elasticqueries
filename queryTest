
import subprocess
import json
from pandas.io.json import json_normalize
from summarizeDataFrame import summarizeDataset
from datetime import datetime

import pandas as pd

# Initialized variables

elasticdatetimecolumn = '_source.@timestamp'


# Query date from elastic search and return a pandas dataframe
command = r'''

curl https://elasticsearch.blueteam.devwerx.org/auditbeat-6.2.2-2018.02.27/_search?size=5000 -u elastic:taiko7Ei

'''
output = subprocess.check_output(['bash','-c', command])

string=output.decode("utf-8")

data = json.loads(string)

df=json_normalize(data['hits']['hits'])

totalHits=str(data['hits']['total'])

print("Total Hits: ",totalHits )
print("Total Recieved",len(df) ,'\n')


# Convert timestamp to date time to sort by datetime

df['DateTime'] =pd.to_datetime(df[elasticdatetimecolumn])

df.sort_values(by=['DateTime'],inplace = True)



#print(df2.dtype)
#summarizeDataset(df[0,:])
print(string)
print(df)

#print(df['DateTime'])
#

#df.to_csv("/home/david/Desktop/new.csv" , sep='\t' , index=False)







#
#     df = json_normalize(item['hits']['hits'])

#print(json_normalize(item['hits']['hits']))
# new=json_normalize(data['responses'])
# data1 = pd.read_json(string,typ='index')
#res['hits']['hits']
#df = pd.concat(map(pd.DataFrame.from_dict, data), axis=1)['hits'].T
#print(new.head())


